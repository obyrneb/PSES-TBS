---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(broom)
library(networkD3)

mainDir <- getwd()
dataDir <- "datasets"

demoMap <- read.csv(file.path(mainDir,dataDir,"PSES2018_Demographic_Mapping.csv"))

TBSdata <- pses2018 %>%
  filter(LEVEL1ID == "26" & SURVEYR == 2018) %>%
  mutate(DemoQ = ifelse(is.na(BYCOND),"TBS",word(BYCOND, 1, sep = " ="))) %>%
  mutate(DKNA = (ifelse(is.na(ANSWER6),0,ANSWER6)+ifelse(is.na(ANSWER7),0,ANSWER7))) %>%
  mutate(notDKNA_n = (100-DKNA)/100*ANSCOUNT) %>%
  mutate(positive_n = round(POSITIVE/100*notDKNA_n),0) %>%
  mutate(neutral_n = round(NEUTRAL/100*notDKNA_n),0) %>%
  mutate(negative_n = round(NEGATIVE/100*notDKNA_n),0) %>%
  drop_na(positive_n,negative_n) %>%
  mutate(neutralNA = ifelse(is.na(neutral_n),TRUE,FALSE)) %>%
  #filter((positive_n + negative_n)>0) %>%
  #filter(neutralNA == FALSE) %>%
  select(QUESTION,DemoQ,BYCOND,#DESCRIP_E,DESCRIP_F,neutralNA
         positive_n,negative_n,neutral_n)

TBSdata$BYCOND[TBSdata$DemoQ == "TBS"] <- "TBS" 

TBSresiduals <- TBSdata %>%
  group_by(QUESTION,DemoQ) %>%
  gather("Sentiment","Freq",positive_n,negative_n,neutral_n) %>%
  do((function(x) augment(chisq.test(xtabs(Freq ~ Sentiment + BYCOND, data=.))))(.)) %>%
  ungroup()

TBSpvalues <- TBSdata %>%
  group_by(QUESTION,DemoQ) %>%
  gather("Sentiment","Freq",positive_n,negative_n,neutral_n) %>%
  do((function(x) tidy(chisq.test(xtabs(Freq ~ Sentiment + BYCOND, data=.))))(.)) %>%
  ungroup()

ChiSquares <- left_join(TBSresiduals,TBSpvalues, by=c("QUESTION","DemoQ")) %>%
  left_join(demoMap, by = "DemoQ") %>% 
  mutate(sentiment = recode(Sentiment, negative_n = "NEGATIVE", neutral_n = "NEUTRAL", positive_n = "POSITIVE"))

TBS_Xsq <- TBS.df %>%
  filter(LEVEL1ID == 26) %>%
  gather("sentiment","prop",POSITIVE,NEUTRAL,NEGATIVE) %>%
  select(QUESTION,TITLE_E,DemoQ,BYCOND,DESCRIP_E,sentiment,prop) %>%
  left_join(select(ChiSquares,QUESTION,DemoQ,DemoQ_E,BYCOND,p.value,sentiment,.stdres,.observed),
            by=c("QUESTION","DemoQ","BYCOND","sentiment")) 
  
significant <- TBS_Xsq %>%
  filter(p.value <= 0.05 & 
           .stdres >= 2 & 
           sentiment == "NEGATIVE") %>%
  select(TITLE_E,DemoQ_E,BYCOND,DESCRIP_E,p.value,sentiment,.stdres,.observed) %>%
  arrange(TITLE_E,BYCOND,p.value)

DemQpairs <- distinct(significant,TITLE_E,DESCRIP_E)
```

```{r}
pairs <- distinct(significant,TITLE_E,DESCRIP_E,.stdres, p.value) 

nodes <- pairs %>%
  gather("group","node") %>%
  distinct() %>%
  mutate(nodeID = row_number()-1)

links_quest <- pairs %>%
  select(node = TITLE_E) %>%
  left_join(nodes, by = "node") %>%
  select(question = nodeID)

links_demo <- pairs %>%
  select(node = DESCRIP_E) %>%
  left_join(nodes, by = "node") %>%
  select(demographic = nodeID)

links_value <- select(pairs, residuals = .stdres, p.value)

links <- bind_cols(links_quest,links_demo,links_value)

forceNetwork(Links = links,
             Nodes = nodes,
             Source = "demographic",
             Target = "question",
             Value = "residuals",
             NodeID = "node",
             Group =  "group",
             colourScale = JS("d3.scaleOrdinal(d3.schemeCategory10);"),
             height = 600,
             width = 800,
             opacity = 0.9,
             opacityNoHover = 0.3,
             legend = TRUE)

#simpleNetwork(DemQpairs)
```
```{r}
# Load data
data(MisLinks)
data(MisNodes)

# Plot
forceNetwork(Links = MisLinks, Nodes = MisNodes,
            Source = "source", Target = "target",
            Value = "value", NodeID = "name",
            Group = "group", opacity = 0.8)
```

```{r}
ggplot(significant, aes(p.value)) +
  geom_freqpoly(binwidth=0.005)
```

```{r}
TBS_Binary <- TBSdata %>%
  filter(neutralNA == TRUE) %>%
  group_by(QUESTION,DemoQ) %>%
  do(Xsq = (function(x) chisq.test(x[,6:7]))(.)) %>%
  ungroup() %>%
  mutate(p.value = as.double(sapply(Xsq,"[", "p.value")))

TBS_PNN <- TBSdata %>%
  filter(neutralNA == FALSE) %>%
  group_by(QUESTION,DemoQ) %>%
  do(Xsq = (function(x) chisq.test(x[,6:8]))(.)) %>%
  # augment(Xsq)
  ungroup() %>%
  mutate(p.value = as.double(sapply(Xsq,"[", "p.value")))

ChiSquares <- bind_rows(TBS_Binary,TBS_PNN)
```