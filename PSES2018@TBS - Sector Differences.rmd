---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}

source("pses2018.R")

library(tidyverse)
library(cowplot)

```

```{r Sector line graph, fig.height= 3.5, fig.width=16 }

sector_qs <- pses2018 %>% 
  filter(LEVEL1ID %in% c(0,26), 
         DemoQ %in% c("org","dept"),
         SURVEYR == 2018) %>%
  mutate(unitcode = ifelse(is.na(BYCOND),
                           LEVEL1ID,
                           word(BYCOND, 2, sep = " = "))) %>%
  filter(unitcode %in% c(000,026,203,300,301,302,400,401,402,403,404,405,406,407,408,305,306,307,308,309,310,311,312,313,314,315)) %>%
  mutate(highlight = case_when(
    unitcode == 0 ~ "Public Service",
    unitcode == 26 ~ "Treasury Board Secretariat",
    unitcode == 310 ~ "Corporate Services Sector",
    TRUE ~ "Other TBS Sectors"
  )) %>% 
  select(QUESTION,SCORE100, highlight,
         DESCRIP_E,DESCRIP_F,BYCOND,
         DemoQ,DemoQ_E,DemoQ_F,
         INDICATORID,INDICATOR_E,INDICATOR_F) %>%
  arrange(desc(DESCRIP_E),desc(SCORE100)) %>%
  mutate(QUESTION = str_sub(QUESTION, start = 2)) %>% 
  drop_na(SCORE100) %>% 
  mutate(INDICATOR_E = fct_reorder(INDICATOR_E, INDICATORID)) %>% 
  mutate(INDICATOR_F = fct_reorder(INDICATOR_F, INDICATORID))

colours <- c("Public Service" = "#37424A",
             "Treasury Board Secretariat" = "#3095B4",
             "Corporate Services Sector" = "#CD202C",
             "Other TBS Sectors" = "grey60")
shapes <- c("Public Service" = 16,
             "Treasury Board Secretariat" = 16,
             "Corporate Services Sector" = 21,
             "Other TBS Sectors" = 16)
linetypes <- c("Public Service" = 3,
             "Treasury Board Secretariat" = 2,
             "Corporate Services Sector" = 1,
             "Other TBS Sectors" = 1)

line_plot_e <- ggplot(sector_qs, aes(x = QUESTION, y = SCORE100,
                               group = DESCRIP_E, colour = highlight, shape = highlight, linetype = highlight)) +
  scale_colour_manual(values = colours) +
  scale_shape_manual(values = shapes) +
  scale_linetype_manual(values = linetypes) +
  geom_line() +
  geom_point(fill = "white") +
  labs(colour = NULL, shape = NULL, linetype = NULL,
       x = "Public Service Employee Survey questions", y = "Score 100") +
  facet_grid(cols = vars(INDICATOR_E), #rows = vars(DemoQ_E),
            scales = "free", space = "free",
            labeller = label_wrap_gen(15)) +
  theme_classic() +
  theme(legend.position = c(.08,.2),
        line = element_line(colour = "grey30"),
        text = element_text(colour = "grey30"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        #panel.background = element_rect(fill = NA, colour = "black"),
        #strip.background = element_rect(colour = NA, fill = "grey90"),
        strip.background = element_blank(),
        strip.text = element_text(size = 8),
        axis.title = element_text(size = 10))
        #axis.title.x = element_blank())

line_plot_f <- ggplot(ee_data, aes(x = QUESTION, y = POSITIVE,
                               group = DESCRIP_F, colour = DESCRIP_F, shape = DESCRIP_F)) +
  scale_colour_manual(values = c("#CD202C","#3095B4")) +
  scale_shape_manual(values = c(16,21)) +
  geom_line() +
  geom_point(fill = "white") +
  labs(colour = NULL, shape = NULL, x = "Questions du Sondage auprès des fonctionnaires fédéraux", y = "Résponses positives (%)") +
  facet_grid(cols = vars(INDICATOR_F), #rows = vars(DemoQ_E),
            scales = "free", space = "free",
            labeller = label_wrap_gen(20)) +
  theme_classic() +
  theme(legend.position = c(.08,.2),
        line = element_line(colour = "grey30"),
        text = element_text(colour = "grey30"),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.text.y = element_text(angle = 90, hjust = 0.5),
        #panel.background = element_rect(fill = NA, colour = "black"),
        #strip.background = element_rect(colour = NA, fill = "grey90"),
        strip.background = element_blank(),
        strip.text = element_text(size = 8),
        axis.title = element_text(size = 10))

line_plot_e
line_plot_f

ggsave(file.path(mainDir,plotDir,"PSES2018@TBS - Sector Line Chart (CSS).svg"),
       plot = line_plot_e, height = 3.5, width = 16)

ggsave(file.path(mainDir,plotDir,"SAFF2018@TBS - Graphique linéaire des secteurs (SSC).svg"),
       plot = line_plot_f, height = 3.5, width = 16)

```